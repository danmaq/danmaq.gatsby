box: 'node:latest'

build:
  steps:
  - script:
      name: Install dependencies.
      code: yarn install
  - script:
      name: Deploy source articles.
      code: git clone https://github.com/danmaq/danmaq.article.git
staging:
  steps:
  - script:
      name: Install gatsby-cli.
      code: yarn global add gatsby-cli
  - script:
      name: Build for staging.
      code: yarn run staging:build --verbose
  - script:
      name: Deploy to staging.
      code: yarn run staging:commit
production:
  steps:
  - script:
      name: Install gatsby-cli.
      code: yarn global add gatsby-cli
  - script:
      name: Cleaning.
      code: yarn run production:clean
  - script:
      name: Cloning dest repository.
      code: |
        yarn run production:clone
  - script:
      name: Cleaning dest repository.
      code: yarn run production:truncate
  - script:
      name: Build for production.
      code: node --max_old_space_size=1792 --stack_size=1280 /usr/local/bin/gatsby build --verbose
#   - script:
#       name: Deploy to production.
#       code: |
#         git config --global user.email 'info@danmaq.com'
#         git config --global user.name 'Shuhei Nomura'
#         yarn run production:commit
#         ./production.exp ${GITHUB_PASS}